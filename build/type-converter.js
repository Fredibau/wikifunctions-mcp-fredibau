// A helper function to construct the detailed Z20838 (float64) object.
function buildFloat64Object(positive, exponent, mantisse, special) {
    return {
        Z1K1: "Z20838",
        Z20838K1: {
            Z1K1: "Z16659",
            Z16659K1: {
                Z1K1: "Z9",
                Z9K1: positive ? "Z16660" : "Z16662",
            },
        },
        Z20838K2: {
            Z1K1: "Z16683",
            Z16683K1: {
                Z1K1: "Z16659",
                "Z16659K1": {
                    Z1K1: "Z9",
                    Z9K1: exponent < 0 ? "Z16662" : exponent === 0 ? "Z16661" : "Z16660",
                },
            },
            "Z16683K2": {
                Z1K1: "Z13518",
                "Z13518K1": {
                    Z1K1: "Z6",
                    "Z6K1": Math.abs(exponent).toString(),
                },
            },
        },
        "Z20838K3": {
            Z1K1: "Z13518",
            "Z13518K1": {
                Z1K1: "Z6",
                "Z6K1": mantisse.toString(),
            },
        },
        "Z20838K4": {
            Z1K1: "Z20825",
            "Z20825K1": {
                Z1K1: "Z9",
                "Z9K1": special,
            },
        },
    };
}
export function convertValueToZObject(value, requiredTypeZid) {
    switch (requiredTypeZid) {
        case "Z16683": {
            // Logic to convert a JavaScript number/BigInt to a Wikifunctions Integer (Z16683) object.
            const num = BigInt(value);
            const absValue = num > 0n ? num : -num;
            let signZid;
            if (num > 0n) {
                signZid = "Z16660"; // Positive
            }
            else if (num < 0n) {
                signZid = "Z16662"; // Negative
            }
            else {
                signZid = "Z16661"; // Zero
            }
            return {
                Z1K1: "Z16683",
                Z16683K1: {
                    Z1K1: "Z16659",
                    Z16659K1: {
                        Z1K1: "Z9",
                        Z9K1: signZid,
                    },
                },
                Z16683K2: {
                    Z1K1: "Z13518",
                    Z13518K1: {
                        Z1K1: "Z6",
                        Z6K1: absValue.toString(),
                    },
                },
            };
        }
        case "Z20838": {
            // Logic to convert a JavaScript number to a Wikifunctions float64 (Z20838) object.
            const num = Number(value);
            if (Number.isNaN(num)) {
                return buildFloat64Object(true, 0, 0n, "Z20834");
            }
            if (num === Number.POSITIVE_INFINITY) {
                return buildFloat64Object(true, 0, 0n, "Z20832");
            }
            if (num === Number.NEGATIVE_INFINITY) {
                return buildFloat64Object(false, 0, 0n, "Z20833");
            }
            if (Object.is(num, -0)) {
                return buildFloat64Object(false, 0, 0n, "Z20831");
            }
            if (num === 0) {
                return buildFloat64Object(true, 0, 0n, "Z20829");
            }
            const positive = num >= 0;
            const absval = positive ? num : -num;
            const buffer = new ArrayBuffer(8);
            const view = new DataView(buffer);
            view.setFloat64(0, absval, false);
            const i = view.getBigUint64(0, false);
            const exponent = (i >> 52n) - 1023n;
            const mantisse = i % 2n ** 52n;
            return buildFloat64Object(positive, Number(exponent), mantisse, "Z20837");
        }
        default: {
            // For types that don't have special conversion logic, wrap them as a string-like object.
            const valueKey = `${requiredTypeZid}K1`;
            return {
                Z1K1: requiredTypeZid,
                [valueKey]: String(value),
            };
        }
    }
}
export function convertZObjectToValue(zObject) {
    if (!zObject || typeof zObject.Z1K1 !== "string") {
        return zObject; // Not a valid Z-Object, return as is.
    }
    const type = zObject.Z1K1;
    switch (type) {
        case "Z16683": {
            // Logic to convert a Wikifunctions Integer (Z16683) object to a JavaScript BigInt.
            let valueStr = zObject.Z16683K2?.Z13518K1;
            if (typeof valueStr === "object" && valueStr !== null && valueStr.Z1K1 === "Z6") {
                valueStr = valueStr.Z6K1;
            }
            if (typeof valueStr !== "string") {
                return zObject; // Malformed integer object
            }
            const value = BigInt(valueStr);
            let sign = zObject.Z16683K1?.Z16659K1;
            while (typeof sign === "object" && sign !== null) {
                if ("Z9K1" in sign) {
                    sign = sign.Z9K1;
                }
                else if ("Z16659K1" in sign) {
                    sign = sign.Z16659K1;
                }
                else {
                    sign = ""; // Break loop
                }
            }
            let signMultiplier;
            if (sign === "Z16662") {
                signMultiplier = -1n;
            }
            else if (sign === "Z16661") {
                signMultiplier = 0n;
            }
            else {
                signMultiplier = 1n;
            }
            if (value > 0n && signMultiplier === 0n) {
                return value;
            }
            return signMultiplier * value;
        }
        case "Z20838": {
            // Logic to convert a Wikifunctions float64 (Z20838) object back to a JavaScript number.
            const special = zObject.Z20838K4?.Z20825K1;
            switch (special) {
                case "Z20834":
                    return NaN;
                case "Z20832":
                    return Number.POSITIVE_INFINITY;
                case "Z20833":
                    return Number.NEGATIVE_INFINITY;
                case "Z20831":
                    return -0;
                case "Z20829":
                    return 0;
            }
            const positive = zObject.Z20838K1?.Z16659K1 === "Z16660";
            const exponentSign = zObject.Z20838K2?.Z16683K1?.Z16659K1;
            const exponentStr = zObject.Z20838K2?.Z16683K2?.Z13518K1;
            const mantisseStr = zObject.Z20838K3?.Z13518K1;
            if (exponentStr === undefined || mantisseStr === undefined) {
                return zObject; // Malformed object
            }
            let exponent = BigInt(exponentStr);
            if (exponentSign === "Z16662") {
                exponent = -exponent;
            }
            const mantisse = BigInt(mantisseStr);
            const i = (exponent + 1023n << 52n) + mantisse;
            const buffer = new ArrayBuffer(8);
            const view = new DataView(buffer);
            view.setBigUint64(0, i, false);
            let value = view.getFloat64(0, false);
            if (!positive) {
                value = -value;
            }
            return value;
        }
        // Default case for simple string-like values (Z6, Z13518, etc.)
        default: {
            const valueKey = `${type}K1`;
            if (Object.prototype.hasOwnProperty.call(zObject, valueKey)) {
                return zObject[valueKey];
            }
            return zObject; // Return the full object if the structure is not recognized.
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHlwZS1jb252ZXJ0ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvdHlwZS1jb252ZXJ0ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsdUVBQXVFO0FBQ3ZFLFNBQVMsa0JBQWtCLENBQ3pCLFFBQWlCLEVBQ2pCLFFBQWdCLEVBQ2hCLFFBQWdCLEVBQ2hCLE9BQWU7SUFFZixPQUFPO1FBQ0wsSUFBSSxFQUFFLFFBQVE7UUFDZCxRQUFRLEVBQUU7WUFDUixJQUFJLEVBQUUsUUFBUTtZQUNkLFFBQVEsRUFBRTtnQkFDUixJQUFJLEVBQUUsSUFBSTtnQkFDVixJQUFJLEVBQUUsUUFBUSxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLFFBQVE7YUFDckM7U0FDRjtRQUNELFFBQVEsRUFBRTtZQUNSLElBQUksRUFBRSxRQUFRO1lBQ2QsUUFBUSxFQUFFO2dCQUNSLElBQUksRUFBRSxRQUFRO2dCQUNkLFVBQVUsRUFBRTtvQkFDVixJQUFJLEVBQUUsSUFBSTtvQkFDVixJQUFJLEVBQUUsUUFBUSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxRQUFRLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLFFBQVE7aUJBQ3JFO2FBQ0Y7WUFDRCxVQUFVLEVBQUU7Z0JBQ1YsSUFBSSxFQUFFLFFBQVE7Z0JBQ2QsVUFBVSxFQUFFO29CQUNWLElBQUksRUFBRSxJQUFJO29CQUNWLE1BQU0sRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDLFFBQVEsRUFBRTtpQkFDdEM7YUFDRjtTQUNGO1FBQ0QsVUFBVSxFQUFFO1lBQ1YsSUFBSSxFQUFFLFFBQVE7WUFDZCxVQUFVLEVBQUU7Z0JBQ1YsSUFBSSxFQUFFLElBQUk7Z0JBQ1YsTUFBTSxFQUFFLFFBQVEsQ0FBQyxRQUFRLEVBQUU7YUFDNUI7U0FDRjtRQUNELFVBQVUsRUFBRTtZQUNWLElB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QUFRLEdBQUcsS0FBSyxJQUFJLEdBQUcsQ0FBQyxHQUFHLFFBQVEsQ0FBQztZQUUvQyxNQUFNLE1BQU0sR0FBRyxJQUFJLFdBQVcsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNsQyxNQUFNLElBQUksR0FBRyxJQUFJLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUNsQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDL0IsSUFBSSxLQUFLLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFFdEMsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO2dCQUNkLEtBQUssR0FBRyxDQUFDLEtBQUssQ0FBQztZQUNqQixDQUFDO1lBQ0QsT0FBTyxLQUFLLENBQUM7UUFDZixDQUFDO1FBRUQsZ0VBQWdFO1FBQ2hFLE9BQU8sQ0FBQyxDQUFDLENBQUM7WUFDUixNQUFNLFFBQVEsR0FBRyxHQUFHLElBQUksSUFBSSxDQUFDO1lBQzdCLElBQUksTUFBTSxDQUFDLFNBQVMsQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxRQUFRLENBQUMsRUFBRSxDQUFDO2dCQUM1RCxPQUFPLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztZQUMzQixDQUFDO1lBQ0QsT0FBTyxPQUFPLENBQUMsQ0FBQyw2REFBNkQ7UUFDL0UsQ0FBQztJQUNILENBQUM7QUFDSCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQSBoZWxwZXIgZnVuY3Rpb24gdG8gY29uc3RydWN0IHRoZSBkZXRhaWxlZCBaMjA4MzggKGZsb2F0NjQpIG9iamVjdC5cclxuZnVuY3Rpb24gYnVpbGRGbG9hdDY0T2JqZWN0KFxyXG4gIHBvc2l0aXZlOiBib29sZWFuLFxyXG4gIGV4cG9uZW50OiBudW1iZXIsXHJcbiAgbWFudGlzc2U6IGJpZ2ludCxcclxuICBzcGVjaWFsOiBzdHJpbmdcclxuKTogYW55IHtcclxuICByZXR1cm4ge1xyXG4gICAgWjFLMTogXCJaMjA4MzhcIixcclxuICAgIFoyMDgzOEsxOiB7XHJcbiAgICAgIFoxSzE6IFwiWjE2NjU5XCIsXHJcbiAgICAgIFoxNjY1OUsxOiB7XHJcbiAgICAgICAgWjFLMTogXCJaOVwiLFxyXG4gICAgICAgIFo5SzE6IHBvc2l0aXZlID8gXCJaMTY2NjBcIiA6IFwiWjE2NjYyXCIsXHJcbiAgICAgIH0sXHJcbiAgICB9LFxyXG4gICAgWjIwODM4SzI6IHtcclxuICAgICAgWjFLMTogXCJaMTY2ODNcIixcclxuICAgICAgWjE2NjgzSzE6IHtcclxuICAgICAgICBaMUsxOiBcIloxNjY1OVwiLFxyXG4gICAgICAgIFwiWjE2NjU5SzFcIjoge1xyXG4gICAgICAgICAgWjFLMTogXCJaOVwiLFxyXG4gICAgICAgICAgWjlLMTogZXhwb25lbnQgPCAwID8gXCJaMTY2NjJcIiA6IGV4cG9uZW50ID09PSAwID8gXCJaMTY2NjFcIiA6IFwiWjE2NjYwXCIsXHJcbiAgICAgICAgfSxcclxuICAgICAgfSxcclxuICAgICAgXCJaMTY2ODNLMlwiOiB7XHJcbiAgICAgICAgWjFLMTogXCJaMTM1MThcIixcclxuICAgICAgICBcIloxMzUxOEsxXCI6IHtcclxuICAgICAgICAgIFoxSzE6IFwiWjZcIixcclxuICAgICAgICAgIFwiWjZLMVwiOiBNYXRoLmFicyhleHBvbmVudCkudG9TdHJpbmcoKSxcclxuICAgICAgICB9LFxyXG4gICAgICB9LFxyXG4gICAgfSxcclxuICAgIFwiWjIwODM4SzNcIjoge1xyXG4gICAgICBaMUsxOiBcIloxMzUxOFwiLFxyXG4gICAgICBcIloxMzUxOEsxXCI6IHtcclxuICAgICAgICBaMUsxOiBcIlo2XCIsXHJcbiAgICAgICAgXCJaNksxXCI6IG1hbnRpc3NlLnRvU3RyaW5nKCksXHJcbiAgICAgIH0sXHJcbiAgICB9LFxyXG4gICAgXCJaMjA4MzhLNFwiOiB7XHJcbiAgICAgIFoxSzE6IFwiWjIwODI1XCIsXHJcbiAgICAgIFwiWjIwODI1SzFcIjoge1xyXG4gICAgICAgIFoxSzE6IFwiWjlcIixcclxuICAgICAgICBcIlo5SzFcIjogc3BlY2lhbCxcclxuICAgICAgfSxcclxuICAgIH0sXHJcbiAgfTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGNvbnZlcnRWYWx1ZVRvWk9iamVjdCh2YWx1ZTogYW55LCByZXF1aXJlZFR5cGVaaWQ6IHN0cmluZyk6IGFueSB7XHJcbiAgc3dpdGNoIChyZXF1aXJlZFR5cGVaaWQpIHtcclxuICAgIGNhc2UgXCJaMTY2ODNcIjoge1xyXG4gICAgICAvLyBMb2dpYyB0byBjb252ZXJ0IGEgSmF2YVNjcmlwdCBudW1iZXIvQmlnSW50IHRvIGEgV2lraWZ1bmN0aW9ucyBJbnRlZ2VyIChaMTY2ODMpIG9iamVjdC5cclxuICAgICAgY29uc3QgbnVtID0gQmlnSW50KHZhbHVlKTtcclxuICAgICAgY29uc3QgYWJzVmFsdWUgPSBudW0gPiAwbiA/IG51bSA6IC1udW07XHJcblxyXG4gICAgICBsZXQgc2lnblppZDtcclxuICAgICAgaWYgKG51bSA+IDBuKSB7XHJcbiAgICAgICAgc2lnblppZCA9IFwiWjE2NjYwXCI7IC8vIFBvc2l0aXZlXHJcbiAgICAgIH0gZWxzZSBpZiAobnVtIDwgMG4pIHtcclxuICAgICAgICBzaWduWmlkID0gXCJaMTY2NjJcIjsgLy8gTmVnYXRpdmVcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBzaWduWmlkID0gXCJaMTY2NjFcIjsgLy8gWmVyb1xyXG4gICAgICB9XHJcblxyXG4gICAgICByZXR1cm4ge1xyXG4gICAgICAgIFoxSzE6IFwiWjE2NjgzXCIsXHJcbiAgICAgICAgWjE2NjgzSzE6IHtcclxuICAgICAgICAgIFoxSzE6IFwiWjE2NjU5XCIsXHJcbiAgICAgICAgICBaMTY2NTlLMToge1xyXG4gICAgICAgICAgICBaMUsxOiBcIlo5XCIsXHJcbiAgICAgICAgICAgIFo5SzE6IHNpZ25aaWQsXHJcbiAgICAgICAgICB9LFxyXG4gICAgICAgIH0sXHJcbiAgICAgICAgWjE2NjgzSzI6IHtcclxuICAgICAgICAgIFoxSzE6IFwiWjEzNTE4XCIsXHJcbiAgICAgICAgICBaMTM1MThLMToge1xyXG4gICAgICAgICAgICBaMUsxOiBcIlo2XCIsXHJcbiAgICAgICAgICAgIFo2SzE6IGFic1ZhbHVlLnRvU3RyaW5nKCksXHJcbiAgICAgICAgICB9LFxyXG4gICAgICAgIH0sXHJcbiAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgY2FzZSBcIloyMDgzOFwiOiB7XHJcbiAgICAgIC8vIExvZ2ljIHRvIGNvbnZlcnQgYSBKYXZhU2NyaXB0IG51bWJlciB0byBhIFdpa2lmdW5jdGlvbnMgZmxvYXQ2NCAoWjIwODM4KSBvYmplY3QuXHJcbiAgICAgIGNvbnN0IG51bSA9IE51bWJlcih2YWx1ZSk7XHJcblxyXG4gICAgICBpZiAoTnVtYmVyLmlzTmFOKG51bSkpIHtcclxuICAgICAgICByZXR1cm4gYnVpbGRGbG9hdDY0T2JqZWN0KHRydWUsIDAsIDBuLCBcIloyMDgzNFwiKTtcclxuICAgICAgfVxyXG4gICAgICBpZiAobnVtID09PSBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFkpIHtcclxuICAgICAgICByZXR1cm4gYnVpbGRGbG9hdDY0T2JqZWN0KHRydWUsIDAsIDBuLCBcIloyMDgzMlwiKTtcclxuICAgICAgfVxyXG4gICAgICBpZiAobnVtID09PSBOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFkpIHtcclxuICAgICAgICByZXR1cm4gYnVpbGRGbG9hdDY0T2JqZWN0KGZhbHNlLCAwLCAwbiwgXCJaMjA4MzNcIik7XHJcbiAgICAgIH1cclxuICAgICAgaWYgKE9iamVjdC5pcyhudW0sIC0wKSkge1xyXG4gICAgICAgIHJldHVybiBidWlsZEZsb2F0NjRPYmplY3QoZmFsc2UsIDAsIDBuLCBcIloyMDgzMVwiKTtcclxuICAgICAgfVxyXG4gICAgICBpZiAobnVtID09PSAwKSB7XHJcbiAgICAgICAgcmV0dXJuIGJ1aWxkRmxvYXQ2NE9iamVjdCh0cnVlLCAwLCAwbiwgXCJaMjA4MjlcIik7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGNvbnN0IHBvc2l0aXZlID0gbnVtID49IDA7XHJcbiAgICAgIGNvbnN0IGFic3ZhbCA9IHBvc2l0aXZlID8gbnVtIDogLW51bTtcclxuXHJcbiAgICAgIGNvbnN0IGJ1ZmZlciA9IG5ldyBBcnJheUJ1ZmZlcig4KTtcclxuICAgICAgY29uc3QgdmlldyA9IG5ldyBEYXRhVmlldyhidWZmZXIpO1xyXG4gICAgICB2aWV3LnNldEZsb2F0NjQoMCwgYWJzdmFsLCBmYWxzZSk7XHJcbiAgICAgIGNvbnN0IGkgPSB2aWV3LmdldEJpZ1VpbnQ2NCgwLCBmYWxzZSk7XHJcblxyXG4gICAgICBjb25zdCBleHBvbmVudCA9IChpID4+IDUybikgLSAxMDIzbjtcclxuICAgICAgY29uc3QgbWFudGlzc2UgPSBpICUgMm4gKiogNTJuO1xyXG4gICAgICByZXR1cm4gYnVpbGRGbG9hdDY0T2JqZWN0KHBvc2l0aXZlLCBOdW1iZXIoZXhwb25lbnQpLCBtYW50aXNzZSwgXCJaMjA4MzdcIik7XHJcbiAgICB9XHJcblxyXG4gICAgZGVmYXVsdDoge1xyXG4gICAgICAvLyBGb3IgdHlwZXMgdGhhdCBkb24ndCBoYXZlIHNwZWNpYWwgY29udmVyc2lvbiBsb2dpYywgd3JhcCB0aGVtIGFzIGEgc3RyaW5nLWxpa2Ugb2JqZWN0LlxyXG4gICAgICBjb25zdCB2YWx1ZUtleSA9IGAke3JlcXVpcmVkVHlwZVppZH1LMWA7XHJcbiAgICAgIHJldHVybiB7XHJcbiAgICAgICAgWjFLMTogcmVxdWlyZWRUeXBlWmlkLFxyXG4gICAgICAgIFt2YWx1ZUtleV06IFN0cmluZyh2YWx1ZSksXHJcbiAgICAgIH07XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gY29udmVydFpPYmplY3RUb1ZhbHVlKHpPYmplY3Q6IGFueSk6IGFueSB7XHJcbiAgaWYgKCF6T2JqZWN0IHx8IHR5cGVvZiB6T2JqZWN0LloxSzEgIT09IFwic3RyaW5nXCIpIHtcclxuICAgIHJldHVybiB6T2JqZWN0OyAvLyBOb3QgYSB2YWxpZCBaLU9iamVjdCwgcmV0dXJuIGFzIGlzLlxyXG4gIH1cclxuXHJcbiAgY29uc3QgdHlwZSA9IHpPYmplY3QuWjFLMTtcclxuXHJcbiAgc3dpdGNoICh0eXBlKSB7XHJcbiAgICBjYXNlIFwiWjE2NjgzXCI6IHtcclxuICAgICAgLy8gTG9naWMgdG8gY29udmVydCBhIFdpa2lmdW5jdGlvbnMgSW50ZWdlciAoWjE2NjgzKSBvYmplY3QgdG8gYSBKYXZhU2NyaXB0IEJpZ0ludC5cclxuICAgICAgbGV0IHZhbHVlU3RyID0gek9iamVjdC5aMTY2ODNLMj8uWjEzNTE4SzE7XHJcbiAgICAgIGlmICh0eXBlb2YgdmFsdWVTdHIgPT09IFwib2JqZWN0XCIgJiYgdmFsdWVTdHIgIT09IG51bGwgJiYgdmFsdWVTdHIuWjFLMSA9PT0gXCJaNlwiKSB7XHJcbiAgICAgICAgdmFsdWVTdHIgPSB2YWx1ZVN0ci5aNksxO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBpZiAodHlwZW9mIHZhbHVlU3RyICE9PSBcInN0cmluZ1wiKSB7XHJcbiAgICAgICAgcmV0dXJuIHpPYmplY3Q7IC8vIE1hbGZvcm1lZCBpbnRlZ2VyIG9iamVjdFxyXG4gICAgICB9XHJcblxyXG4gICAgICBjb25zdCB2YWx1ZSA9IEJpZ0ludCh2YWx1ZVN0cik7XHJcblxyXG4gICAgICBsZXQgc2lnbjogYW55ID0gek9iamVjdC5aMTY2ODNLMT8uWjE2NjU5SzE7XHJcbiAgICAgIHdoaWxlICh0eXBlb2Ygc2lnbiA9PT0gXCJvYmplY3RcIiAmJiBzaWduICE9PSBudWxsKSB7XHJcbiAgICAgICAgaWYgKFwiWjlLMVwiIGluIHNpZ24pIHtcclxuICAgICAgICAgIHNpZ24gPSBzaWduLlo5SzE7XHJcbiAgICAgICAgfSBlbHNlIGlmIChcIloxNjY1OUsxXCIgaW4gc2lnbikge1xyXG4gICAgICAgICAgc2lnbiA9IHNpZ24uWjE2NjU5SzE7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIHNpZ24gPSBcIlwiOyAvLyBCcmVhayBsb29wXHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcblxyXG4gICAgICBsZXQgc2lnbk11bHRpcGxpZXI6IGJpZ2ludDtcclxuICAgICAgaWYgKHNpZ24gPT09IFwiWjE2NjYyXCIpIHtcclxuICAgICAgICBzaWduTXVsdGlwbGllciA9IC0xbjtcclxuICAgICAgfSBlbHNlIGlmIChzaWduID09PSBcIloxNjY2MVwiKSB7XHJcbiAgICAgICAgc2lnbk11bHRpcGxpZXIgPSAwbjtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBzaWduTXVsdGlwbGllciA9IDFuO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBpZiAodmFsdWUgPiAwbiAmJiBzaWduTXVsdGlwbGllciA9PT0gMG4pIHtcclxuICAgICAgICByZXR1cm4gdmFsdWU7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIHJldHVybiBzaWduTXVsdGlwbGllciAqIHZhbHVlO1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICBjYXNlIFwiWjIwODM4XCI6IHtcclxuICAgICAgLy8gTG9naWMgdG8gY29udmVydCBhIFdpa2lmdW5jdGlvbnMgZmxvYXQ2NCAoWjIwODM4KSBvYmplY3QgYmFjayB0byBhIEphdmFTY3JpcHQgbnVtYmVyLlxyXG4gICAgICBjb25zdCBzcGVjaWFsID0gek9iamVjdC5aMjA4MzhLND8uWjIwODI1SzE7XHJcbiAgICAgIHN3aXRjaCAoc3BlY2lhbCkge1xyXG4gICAgICAgIGNhc2UgXCJaMjA4MzRcIjpcclxuICAgICAgICAgIHJldHVybiBOYU47XHJcbiAgICAgICAgY2FzZSBcIloyMDgzMlwiOlxyXG4gICAgICAgICAgcmV0dXJuIE51bWJlci5QT1NJVElWRV9JTkZJTklUWTtcclxuICAgICAgICBjYXNlIFwiWjIwODMzXCI6XHJcbiAgICAgICAgICByZXR1cm4gTnVtYmVyLk5FR0FUSVZFX0lORklOSVRZO1xyXG4gICAgICAgIGNhc2UgXCJaMjA4MzFcIjpcclxuICAgICAgICAgIHJldHVybiAtMDtcclxuICAgICAgICBjYXNlIFwiWjIwODI5XCI6XHJcbiAgICAgICAgICByZXR1cm4gMDtcclxuICAgICAgfVxyXG5cclxuICAgICAgY29uc3QgcG9zaXRpdmUgPSB6T2JqZWN0LloyMDgzOEsxPy5aMTY2NTlLMSA9PT0gXCJaMTY2NjBcIjtcclxuICAgICAgY29uc3QgZXhwb25lbnRTaWduID0gek9iamVjdC5aMjA4MzhLMj8uWjE2NjgzSzE/LloxNjY1OUsxO1xyXG4gICAgICBjb25zdCBleHBvbmVudFN0ciA9IHpPYmplY3QuWjIwODM4SzI/LloxNjY4M0syPy5aMTM1MThLMTtcclxuICAgICAgY29uc3QgbWFudGlzc2VTdHIgPSB6T2JqZWN0LloyMDgzOEszPy5aMTM1MThLMTtcclxuXHJcbiAgICAgIGlmIChleHBvbmVudFN0ciA9PT0gdW5kZWZpbmVkIHx8IG1hbnRpc3NlU3RyID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgICByZXR1cm4gek9iamVjdDsgLy8gTWFsZm9ybWVkIG9iamVjdFxyXG4gICAgICB9XHJcblxyXG4gICAgICBsZXQgZXhwb25lbnQgPSBCaWdJbnQoZXhwb25lbnRTdHIpO1xyXG4gICAgICBpZiAoZXhwb25lbnRTaWduID09PSBcIloxNjY2MlwiKSB7XHJcbiAgICAgICAgZXhwb25lbnQgPSAtZXhwb25lbnQ7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGNvbnN0IG1hbnRpc3NlID0gQmlnSW50KG1hbnRpc3NlU3RyKTtcclxuXHJcbiAgICAgIGNvbnN0IGkgPSAoZXhwb25lbnQgKyAxMDIzbiA8PCA1Mm4pICsgbWFudGlzc2U7XHJcblxyXG4gICAgICBjb25zdCBidWZmZXIgPSBuZXcgQXJyYXlCdWZmZXIoOCk7XHJcbiAgICAgIGNvbnN0IHZpZXcgPSBuZXcgRGF0YVZpZXcoYnVmZmVyKTtcclxuICAgICAgdmlldy5zZXRCaWdVaW50NjQoMCwgaSwgZmFsc2UpO1xyXG4gICAgICBsZXQgdmFsdWUgPSB2aWV3LmdldEZsb2F0NjQoMCwgZmFsc2UpO1xyXG5cclxuICAgICAgaWYgKCFwb3NpdGl2ZSkge1xyXG4gICAgICAgIHZhbHVlID0gLXZhbHVlO1xyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiB2YWx1ZTtcclxuICAgIH1cclxuXHJcbiAgICAvLyBEZWZhdWx0IGNhc2UgZm9yIHNpbXBsZSBzdHJpbmctbGlrZSB2YWx1ZXMgKFo2LCBaMTM1MTgsIGV0Yy4pXHJcbiAgICBkZWZhdWx0OiB7XHJcbiAgICAgIGNvbnN0IHZhbHVlS2V5ID0gYCR7dHlwZX1LMWA7XHJcbiAgICAgIGlmIChPYmplY3QucHJvdG90eXBlLmhhc093blByb3BlcnR5LmNhbGwoek9iamVjdCwgdmFsdWVLZXkpKSB7XHJcbiAgICAgICAgcmV0dXJuIHpPYmplY3RbdmFsdWVLZXldO1xyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiB6T2JqZWN0OyAvLyBSZXR1cm4gdGhlIGZ1bGwgb2JqZWN0IGlmIHRoZSBzdHJ1Y3R1cmUgaXMgbm90IHJlY29nbml6ZWQuXHJcbiAgICB9XHJcbiAgfVxyXG59XHJcbiJdfQ==